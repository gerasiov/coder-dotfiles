#!/bin/bash
set -e

# Configuration
DOTFILES_REPO="https://github.com/gerasiov/dotfiles.git"
DOTFILES_DIR="/workspaces/.config/dotfiles"
DOTFILES_HOME_DIR="${DOTFILES_DIR}/home"
CONFIG_DIR="/workspaces/.config"
ENVIRONMENT_LOCAL="${HOME}/.environment-local"

echo "Setting up dotfiles..."

# Clone dotfiles repository if it doesn't exist
if [ ! -d "$DOTFILES_DIR" ]; then
    echo "Cloning dotfiles repository to ${DOTFILES_DIR}..."
    mkdir -p "$(dirname "$DOTFILES_DIR")"
    git clone "$DOTFILES_REPO" "$DOTFILES_DIR"
else
    echo "Dotfiles repository already exists at ${DOTFILES_DIR}"
fi

# Create symlinks for files in home directory
if [ -d "$DOTFILES_HOME_DIR" ]; then
    echo "Creating symlinks for dotfiles..."
    
    # Find all files (not directories) in the home directory
    while IFS= read -r -d '' file; do
        # Get relative path from DOTFILES_HOME_DIR
        rel_path="${file#$DOTFILES_HOME_DIR/}"
        
        # Target path in $HOME
        target="${HOME}/${rel_path}"
        
        # Create parent directory if needed
        target_dir="$(dirname "$target")"
        if [ ! -d "$target_dir" ]; then
            echo "Creating directory: ${target_dir}"
            mkdir -p "$target_dir"
        fi
        
        # Create symlink (backup existing file if needed)
        if [ -e "$target" ] && [ ! -L "$target" ]; then
            backup_file="${target}.backup.$(date +%Y%m%d%H%M%S)"
            echo "Backing up existing file: ${target} -> ${backup_file}"
            mv "$target" "${backup_file}"
        elif [ -L "$target" ]; then
            # Remove existing symlink
            rm "$target"
        fi
        
        echo "Creating symlink: ${target} -> ${file}"
        ln -s "$file" "$target"
        
    done < <(find "$DOTFILES_HOME_DIR" -type f -print0)
else
    echo "Warning: ${DOTFILES_HOME_DIR} does not exist"
fi

# Configure git if environment variables are set
if [ -n "$GIT_AUTHOR_NAME" ] || [ -n "$GIT_AUTHOR_EMAIL" ] || [ -n "$GIT_COMMITTER_NAME" ] || [ -n "$GIT_COMMITTER_EMAIL" ]; then
    echo "Configuring git with environment variables..."
    
    if [ -n "$GIT_AUTHOR_NAME" ]; then
        git config --global user.name "$GIT_AUTHOR_NAME"
        echo "Set git user.name to: $GIT_AUTHOR_NAME"
    fi
    
    if [ -n "$GIT_AUTHOR_EMAIL" ]; then
        git config --global user.email "$GIT_AUTHOR_EMAIL"
        echo "Set git user.email to: $GIT_AUTHOR_EMAIL"
    fi
fi

# Generate .environment-local file
echo "Generating ${ENVIRONMENT_LOCAL}..."
cat > "$ENVIRONMENT_LOCAL" << EOF
# Generated by dotfiles install script
# History directory and file locations in ${CONFIG_DIR}

# Ensure config directories exist
mkdir -p ${CONFIG_DIR}/history

# Bash history
export HISTDIR=${CONFIG_DIR}/history
export HISTFILE=${CONFIG_DIR}/history/shellhistory

# Less history
export LESSHISTFILE=${CONFIG_DIR}/lesshst

# Process HOST variable - remove leading "ws-" and replace all "--" with "-"
if [ -n "\${HOST}" ]; then
    export HOST="\${HOST#ws-}"
    export HOST="\${HOST//--/-}"
fi

# Unset git environment variables after configuration
unset GIT_AUTHOR_NAME
unset GIT_AUTHOR_EMAIL
unset GIT_COMMITTER_NAME
unset GIT_COMMITTER_EMAIL
EOF

echo "Dotfiles setup complete!"
echo "Source ${ENVIRONMENT_LOCAL} in your shell configuration to apply the environment overrides."
