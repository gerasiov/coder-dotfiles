#!/bin/bash
set -e

# Configuration
DOTFILES_REPO="https://github.com/gerasiov/dotfiles.git"
DOTFILES_DIR="/workspaces/.config/dotfiles"
DOTFILES_HOME_DIR="${DOTFILES_DIR}/home"
CONFIG_DIR="/workspaces/.config"
ENVIRONMENT_LOCAL="${HOME}/.environment-local"

echo "Setting up dotfiles..."

# Clone dotfiles repository if it doesn't exist
if [ ! -d "$DOTFILES_DIR" ]; then
    echo "Cloning dotfiles repository to ${DOTFILES_DIR}..."
    mkdir -p "$(dirname "$DOTFILES_DIR")"
    git clone "$DOTFILES_REPO" "$DOTFILES_DIR"
else
    echo "Dotfiles repository already exists at ${DOTFILES_DIR}"
fi

# Create symlinks for files in home directory
if [ -d "$DOTFILES_HOME_DIR" ]; then
    echo "Creating symlinks for dotfiles..."
    
    # Find all files (not directories) in the home directory
    while IFS= read -r -d '' file; do
        # Get relative path from DOTFILES_HOME_DIR
        rel_path="${file#$DOTFILES_HOME_DIR/}"
        
        # Target path in $HOME
        target="${HOME}/${rel_path}"
        
        # Create parent directory if needed
        target_dir="$(dirname "$target")"
        if [ ! -d "$target_dir" ]; then
            echo "Creating directory: ${target_dir}"
            mkdir -p "$target_dir"
        fi
        
        # Create symlink (backup existing file if needed)
        if [ -e "$target" ] && [ ! -L "$target" ]; then
            echo "Backing up existing file: ${target} -> ${target}.backup"
            mv "$target" "${target}.backup"
        fi
        
        if [ -L "$target" ]; then
            # Remove existing symlink
            rm "$target"
        fi
        
        echo "Creating symlink: ${target} -> ${file}"
        ln -s "$file" "$target"
        
    done < <(find "$DOTFILES_HOME_DIR" -type f -print0)
else
    echo "Warning: ${DOTFILES_HOME_DIR} does not exist"
fi

# Generate .environment-local file
echo "Generating ${ENVIRONMENT_LOCAL}..."
cat > "$ENVIRONMENT_LOCAL" << EOF
# Generated by dotfiles install script
# History directory and file locations in ${CONFIG_DIR}

# Ensure config directory exists
mkdir -p ${CONFIG_DIR}

# Bash history
export HISTDIR=${CONFIG_DIR}
export HISTFILE=${CONFIG_DIR}/.bash_history

# Less history
export LESSHISTFILE=${CONFIG_DIR}/.lesshst
EOF

echo "Dotfiles setup complete!"
echo "Source ${ENVIRONMENT_LOCAL} in your shell configuration to apply the environment overrides."
